# 定时任务

## 说明

在实际项目中，我们经常会有一些任务是需要定时执行的。

虽然有 `cron`、`crontab`、`systemd` 等系统级内置的，定时任务工具存在。

但是他们的一些让人掉头发的配置写法，以及增加运维心智负担，无法适应多实例部署场景等等原因，势必需要在 imi 框架中提供这个功能。

## 设计

imi 通过增加一个 `CronProcess` 进程用于定时任务的调度和执行，使用 `Redis` 作为数据存储。

定时任务支持在以下进程中执行： `Task` 进程、`Worker` 进程，也支持新运行一个 `Process` 进程。

支持设置某进程在多实例中只运行一个。

支持任务失败重试、监听。

支持日志记录：开始时间、结束时间、耗时、是否成功、内存占用、错误信息

定时任务进程支持热更新，更新业务代码通过重启进程来重新加载，无需重启整个服务。

定时任务配置允许热更新，动态加载，无需重启。

支持独立运行任务进程，但无法指定 `Task`、`Worker` 运行。

## 使用

### 定义任务

#### Task 任务

与异步任务等同，不再赘述

#### Process 任务

与进程等同，不再赘述

#### 协程任务

实现 `Imi\Cron\Contract\ICronTask` 接口、`run()` 方法

### 定时规则

支持注解设定和配置文件设定两种模式，其中配置文件设定，是可以覆盖注解设定的。

#### 注解设定

注解 `@Cron`，类 `Imi\Cron\Annotation\Cron`

`@Cron(id="任务唯一ID", type="", year="", month="", day="", hour="", minute="", second="", unique=false, muiltServerUnique=false, redisPool="", lockWaitTimeout="", lockExpire="")`

##### 属性

###### id

使用`@Cron`注解时的任务唯一ID。如果是 `Task`、`Process`，默认使用 `Task` 或 `Process` + 名称。

##### type

任务类型

可选：

`worker`-工作进程任务

`task`-任务

`process`-进程

###### year

指定任务执行年份，默认为 `*`。

`*` - 不限制

`2019` - 指定年

`2019-2022` - 指定年份区间

`2019,2021,2022` - 指定多个年份

`2n` - 每 2 年，其它以此类推

###### month

指定任务执行月份，默认为 `*`。

`*` - 不限制

`1` (1 月), `-1` (12 月) - 指定月份，支持负数为倒数的月

`1-6` (1-6 月), `-3--1` (10-12 月) - 指定月份区间，支持负数为倒数的月

`1,3,5,-1` (1、3、5、12 月) - 指定多个月份，支持负数为倒数的月

`2n` - 每 2 个月，其它以此类推

###### day

指定任务执行日期，默认为 `*`。

`*` - 不限制

`1` (1 日), `-1` (每月最后一天) - 指定日期，支持负数为倒数的日期

`1-6` (1-6 日), `-3--1` (每月倒数 3 天) - 指定日期区间，支持负数为倒数的日期

`1,3,5,-1` (每月 1、3、5、最后一天) - 指定多个日期，支持负数为倒数的日期

`2n` - 每 2 天，其它以此类推

`year 1` (一年中的第 1 日), `year -1` (每年最后一天) - 指定一年中的日期，支持负数为倒数的日期

`1-6` (一年中的第 1-6 日), `-3--1` (每年倒数 3 天) - 指定一年中的日期区间，支持负数为倒数的日期

`1,3,5,-1` (每年 1、3、5、最后一天) - 指定一年中的多个日期，支持负数为倒数的日期

`year 2n` - 一年中每 2 天，其它以此类推

###### week

指定任务执行周，默认为 `*`。

`*` - 不限制

`1` (周一), `-1` (周日) - 指定周几（1-7），支持负数为倒数的周

`1-6` (周一到周六), `-3--1` (周五到周日) - 指定周几，支持负数为倒数的周

`1,3,5,-1` (周一、三、五、日) - 指定多个日期，支持负数为倒数的周

`year 1` (每年第一周), `year -1` (每年最后一周) - 指定一年中的第几周，支持负数为倒数的周

`year 1-6` (每年第 1 到 6 周), `year -3--1` (每年倒数 3 周) - 指定一年中的周区间

`year 1,3,5,-1` (每年第1、3、5、倒数第 1 周) - 指定一年中的多个周

`year 2n` - 一年中每 2 周，其它以此类推

`month 1` (每月第一周), `month -1` (每月最后一周) - 指定一个月中的第几周，支持负数为倒数的周

`month 1-3` (每月第 1 到 3 周), `month -3--1` (每月倒数 3 周) - 指定一个月中的周区间

`month 1,2,-1` (每月第1、2、倒数第 1 周) - 指定一个月中的多个周

`month 2n` - 一个月中每 2 周，其它以此类推

##### hour

指定任务执行小时，默认为 `*`。

`*` - 不限制

`0` (0 点), `-1` (23 点) - 指定小时，支持负数为倒数的小时

`1-6` (1-6 店), `-3--1` (21-23 点) - 指定小时区间，支持负数为倒数的小时

`1,3,5,-1` (1、3、5、23 点) - 指定多个小时，支持负数为倒数的小时

`2n` - 每 2 小时，其它以此类推

##### minute

指定任务执行分钟，默认为 `*`。

`*` - 不限制

`0` (0 分), `-1` (23 分) - 指定分钟，支持负数为倒数的分钟

`1-6` (1-6 分), `-3--1` (57-59 分) - 指定分钟区间，支持负数为倒数的分钟

`1,3,5,-1` (1、3、5、59 分) - 指定多个分钟，支持负数为倒数的分钟

`2n` - 每 2 分钟，其它以此类推

##### second

指定任务执行秒，默认为 `*`。

`*` - 不限制

`0` (0 秒), `-1` (23 秒) - 指定秒，支持负数为倒数的秒

`1-6` (1-6 秒), `-3--1` (57-59 秒) - 指定秒区间，支持负数为倒数的秒

`1,3,5,-1` (1、3、5、59 秒) - 指定多个秒，支持负数为倒数的秒

`2n` - 每 2 秒，其它以此类推

##### unique

在当前服务实例中唯一，只能同时执行一个

##### muiltServerUnique

在多台服务器中唯一，适合多实例部署情况下的只能同时执行一个

##### redisPool

用于锁的 `Redis` 连接池名

##### lockWaitTimeout

获取锁超时时间，单位：秒

##### lockExpire

锁超时时间，单位：秒，每个任务预期执行时间应该小于这个时间。超过这个时间未执行完，可能导致再次执行。

#### 配置文件设定

项目配置文件，`beans` 节中配置

```php
[
    'CronManager'   =>  [
        'tasks' =>  [
            // 任务唯一ID
            'taskName'  =>  [
                // 任务类型，可选：worker-工作进程任务; task-任务; process-进程
                'type'      =>  'worker',
                // 任务执行回调，可以是callable类型，也可以是 task、process 名
                'task'      =>  mixed,
                // 定时配置
                'cron'     =>  [
                    // 支持多个条件去触发
                    // 规则同 @Cron 注解
                    [
                        'year'  =>  '',
                        'month' =>  '',
                        'day'   =>  '',
                        'week'  =>  '',
                        'hour'  =>  '',
                        'minute'=>  '',
                        'second'=>  '',
                    ],
                ],
                // 可选配置
                'data'              =>  null,
                'unique'            =>  false,
                'muiltServerUnique' =>  false,
                'redisPool'         =>  'redis',
                'lockWaitTimeout'   =>  10,
                'lockExpire'        =>  120,
            ],
        ],
    ],
]
```
